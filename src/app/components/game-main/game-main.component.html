<div class="game-main-container">
  <!-- Error Boundary -->
  @if (hasError) {
    <div class="error-boundary-wrapper">
      <app-error-boundary
        title="Lá»—i táº£i game"
        [message]="errorMessage"
        [details]="errorDetails"
        [showDetails]="true"
        (retry)="onErrorRetry()"
        (reset)="onErrorReset()">
      </app-error-boundary>
    </div>
  }

  <!-- Loading Overlay -->
  @if (isLoading && !hasError) {
    <div class="loading-overlay-container">
      <div class="loading-content">
        <div class="loading-spinner-large"></div>
        <p class="loading-text">Äang táº£i game...</p>
      </div>
    </div>
  }

  <!-- Header - same style as setup with action buttons -->
  <div class="setup-header">
    <div class="header-left">
      <button class="header-btn config-btn" (click)="openConfigModal()" title="Cáº¥u hÃ¬nh xÃºc xáº¯c" [disabled]="isLoading || isRolling">
        <span class="btn-icon">âš™ï¸</span>
        <span class="btn-text">Cáº¥u hÃ¬nh</span>
      </button>
      <button 
        class="header-btn show-all-btn" 
        (click)="toggleShowAllPlayersPositions()" 
        title="Hiá»‡n/áº¨n táº¥t cáº£ vá»‹ trÃ­ ngÆ°á»i chÆ¡i"
        [class.active]="showAllPlayersPositions"
        [disabled]="isLoading || isRolling">
        <span class="btn-icon">{{ showAllPlayersPositions ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}</span>
        <span class="btn-text">Vá»‹ trÃ­</span>
      </button>
      <div class="round-badge">
        <span class="round-label">Round</span>
        <span class="round-number">{{ currentRound }}</span>
      </div>
    </div>
    <div class="header-center">
    </div>
    <div class="header-right">
      <button class="header-btn reset-btn" (click)="showResetDialog()" title="Khá»Ÿi Ä‘á»™ng láº¡i game" [disabled]="isLoading || isRolling">
        <img [src]="restartIconPath" alt="Reset" class="btn-icon-img">
        <span class="btn-text">Khá»Ÿi Ä‘á»™ng láº¡i</span>
      </button>
    </div>
  </div>

  <!-- Main game layout - 3 columns with ratio 3:4:5 -->
  <main class="game-layout" [class.loading]="isLoading">
    <!-- Column 1: Dice Roller List (3 parts) -->
    <section class="column column-dice">
      <div class="dice-roller-section">
        <app-dice-roller-list></app-dice-roller-list>
      </div>
    </section>

    <!-- Column 2: Leaderboard with Target Selection (4 parts) -->
    <section class="column column-leaderboard">
      <app-leaderboard></app-leaderboard>
    </section>

    <!-- Column 3: Board with Dice Action (5 parts) -->
    <section class="column column-board">
      <div class="board-section">
        <app-board></app-board>
      </div>
      
      <!-- Dice Roll Button and Result - Below Board -->
      <div class="dice-action-section">
        @if (showDiceAnimation) {
          <div class="dice-animation">
            <img [src]="diceAnimationPath" alt="Rolling dice..." class="dice-gif">
          </div>
        } @else if (showDiceResult && lastDiceResult !== null) {
          <div class="dice-result">
            <app-dice-display [value]="lastDiceResult"></app-dice-display>
          </div>
        }
        
        <button 
          class="roll-dice-btn" 
          [disabled]="!canRollDice"
          (click)="onRollDice()"
          [class.rolling]="isRolling">
          @if (isRolling) {
            <span>Äang tung...</span>
          } @else {
            <span>ğŸ² Tung xÃºc xáº¯c</span>
          }
        </button>
        
        @if (diceRollCountdown > 0 && !isRolling && selectedTarget) {
          <div class="dice-countdown" [class.urgent]="diceRollCountdown <= 3">
            <span class="countdown-circle">{{ diceRollCountdown }}</span>
            <span class="countdown-text">Thá»i gian cÃ²n láº¡i</span>
          </div>
        }
        
        @if (diceRollTimeExpired && !isRolling && selectedTarget) {
          <div class="dice-time-expired">
            <span class="expired-icon">â°</span>
            <span class="expired-text">Tung Ä‘iiiiiiiiii</span>
          </div>
        }
        
        @if (!selectedTarget && !isRolling) {
          <p class="hint-text">Chá»n ngÆ°á»i chÆ¡i má»¥c tiÃªu Ä‘á»ƒ tung xÃºc xáº¯c</p>
        }
      </div>
    </section>
  </main>

  <!-- Game Finished Overlay -->
  @if (isGameFinished && showGameFinishedModal) {
    <div class="game-finished-overlay" (click)="closeGameFinishedModal()">
      <div class="game-finished-content" (click)="$event.stopPropagation()">
        <button class="close-btn" (click)="closeGameFinishedModal()" title="ÄÃ³ng">âœ•</button>
        <h2>ğŸ† Game káº¿t thÃºc!</h2>
        <p>Táº¥t cáº£ ngÆ°á»i chÆ¡i Ä‘Ã£ hoÃ n thÃ nh. Xem báº£ng xáº¿p háº¡ng cuá»‘i cÃ¹ng.</p>
        <div class="game-finished-actions">
          <button class="view-leaderboard-btn" (click)="closeGameFinishedModal()">
            Xem báº£ng xáº¿p háº¡ng
          </button>
          <button class="new-game-btn" (click)="showResetDialog()">
            ChÆ¡i game má»›i
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Reset Confirmation Dialog -->
  @if (showResetConfirmation) {
    <div class="modal-overlay" (click)="cancelReset()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>XÃ¡c nháº­n khá»Ÿi Ä‘á»™ng láº¡i</h3>
        <p>Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n khá»Ÿi Ä‘á»™ng láº¡i game? Táº¥t cáº£ dá»¯ liá»‡u hiá»‡n táº¡i sáº½ bá»‹ xÃ³a.</p>
        <div class="modal-actions">
          <button class="btn-cancel" (click)="cancelReset()">Há»§y</button>
          <button class="btn-confirm" (click)="confirmReset()">XÃ¡c nháº­n</button>
        </div>
      </div>
    </div>
  }

  <!-- Ladder Choice Modal (Requirements 12.2) -->
  @if (showLadderChoiceModal && currentLadder) {
    <div class="modal-overlay ladder-modal-overlay">
      <div class="modal-content ladder-choice-modal" (click)="$event.stopPropagation()">
        <div class="ladder-modal-header">
          <span class="ladder-icon">ğŸªœ</span>
          <h3>{{ ladderChoicePlayerName }} Ä‘ang á»Ÿ chÃ¢n thang!</h3>
        </div>
        <div class="ladder-modal-body">
          <p class="ladder-question">CÃ³ muá»‘n leo lÃªn Ä‘á»‰nh thang khÃ´ng?</p>
          <div class="ladder-info">
            <span class="from-position">Ã” {{ currentLadder.startPosition }}</span>
            <span class="arrow">â†’</span>
            <span class="to-position">Ã” {{ currentLadder.endPosition }}</span>
          </div>
          <div class="ladder-countdown" [class.urgent]="ladderCountdown <= 2">
            <span class="countdown-label">Tá»± Ä‘á»™ng leo sau:</span>
            <span class="countdown-value">{{ ladderCountdown }}s</span>
          </div>
        </div>
        <div class="ladder-modal-actions">
          <button class="btn-stay" (click)="onDeclineLadder()">
            á» láº¡i
          </button>
          <button class="btn-climb" (click)="onAcceptLadder()">
            Leo thang ğŸš€
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Dice Configuration Modal -->
  @if (showConfigModal) {
    <div class="modal-overlay config-modal-overlay" (click)="closeConfigModal()">
      <div class="modal-content config-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>âš™ï¸ Cáº¥u hÃ¬nh xÃºc xáº¯c</h3>
          <button class="close-btn" (click)="closeConfigModal()" title="ÄÃ³ng">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="config-row">
            <label for="modalMaxPoints">Sá»‘ Ä‘iá»ƒm maximum:</label>
            <input 
              type="number" 
              id="modalMaxPoints"
              [(ngModel)]="configMaxPoints" 
              min="1"
              (keyup.enter)="applyConfigFromModal()"
              placeholder="Nháº­p sá»‘ Ä‘iá»ƒm (tá»‘i thiá»ƒu 1)">
          </div>
          <div class="config-row current-info">
            <span class="label">Hiá»‡n táº¡i:</span>
            <span class="value">1-{{ currentMaxPoints }}</span>
          </div>
          <div class="config-row round-info">
            <span class="label">Round hiá»‡n táº¡i:</span>
            <span class="value round-value">{{ currentRound }}</span>
          </div>
          @if (pendingMaxPoints !== null) {
            <div class="pending-info">
              <span class="pending-icon">â³</span>
              <span>Cáº¥u hÃ¬nh má»›i (1-{{ pendingMaxPoints }}) sáº½ Ã¡p dá»¥ng tá»« round {{ currentRound + 1 }}</span>
            </div>
          }
          @if (configValidationError) {
            <div class="validation-message error">
              {{ configValidationError }}
            </div>
          }
          @if (configSuccessMessage) {
            <div class="validation-message success">
              {{ configSuccessMessage }}
            </div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="closeConfigModal()">ÄÃ³ng</button>
          <button class="btn-apply-next-round" (click)="applyConfigFromModal()" [disabled]="!isValidModalConfig()">
            Ãp dá»¥ng tá»« round sau
          </button>
          <button class="btn-apply-immediate" (click)="applyConfigImmediate()" [disabled]="!isValidModalConfig()">
            Ãp dá»¥ng ngay
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Finish Celebration Modal -->
  @if (showFinishModal) {
    <div class="modal-overlay finish-modal-overlay" (click)="closeFinishModal()">
      <div class="modal-content finish-modal" [class.special-win]="finishIsSpecialWin" (click)="$event.stopPropagation()">
        <div class="finish-modal-content">
          @if (finishIsSpecialWin) {
            <div class="confetti-container">
              <span class="confetti">ğŸŠ</span>
              <span class="confetti">ğŸ‰</span>
              <span class="confetti">âœ¨</span>
              <span class="confetti">ğŸŠ</span>
              <span class="confetti">ğŸ‰</span>
            </div>
            <div class="trophy-icon">ğŸ†</div>
            <h2 class="finish-title special">CHÃšC Má»ªNG!</h2>
            <p class="player-name-highlight">{{ finishPlayerName }}</p>
            @if (finishPlayerRank === 16) {
              <p class="finish-message special">Vá» Ä‘Ã­ch á»Ÿ vá»‹ trÃ­ <span class="rank-badge special">#{{ finishPlayerRank }}</span></p>
              <p class="special-note">ğŸ‚ Ká»· niá»‡m 16 nÄƒm DL! ğŸ‚</p>
            } @else {
              <p class="finish-message special">Vá» Ä‘Ã­ch á»Ÿ vá»‹ trÃ­ chiáº¿n tháº¯ng Ä‘áº·c biá»‡t <span class="rank-badge special">#{{ finishPlayerRank }}</span></p>
            }
          } @else {
            <div class="finish-icon">ğŸ‰</div>
            <h2 class="finish-title">HoÃ n thÃ nh!</h2>
            <p class="player-name-highlight">{{ finishPlayerName }}</p>
            <p class="finish-message">Vá» Ä‘Ã­ch á»Ÿ vá»‹ trÃ­ <span class="rank-badge">#{{ finishPlayerRank }}</span></p>
          }
        </div>
        <button class="close-finish-btn" (click)="closeFinishModal()">ÄÃ³ng</button>
      </div>
    </div>
  }
</div>
